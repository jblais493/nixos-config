#+title: Joshua Blais' Nix Configuration

This is a literate file using [[https://orgmode.org/][org-mode]] to [[https://orgmode.org/manual/Extracting-Source-Code.html][tangle]] all code blocks to various Nix files across the configuration. I am used to one, massive, partially organized file (see my Emacs Configuration), so this seemed natural: Documentation and configuration all in one file? How nice.

* Introduction
NixOS is what I would refer to as "the endgame of system management". I have used various distributions of Linux in the past, and while I have no gripes with the likes of Debian, Fedora, or Arch, I have always forgotten configuration settings in the past, or had breaking changes on each and every distro. NixOS offers the bleeding edge with the stable, allowing easy rollbacks of any issues, allowing me to  continue on with work and then fix things at a later date. This is increasingly important as I host various projects and services for a broader audience and cannot deal with any downtime.

What makes this possible is:
- NixOS
- Home-manager
- deploy-rs
- nixos-anywhere
- org-mode (this document)

With this one document, my *entire computing landscape is declared*. This is the power of Nix.

* Hosts
** Theologica
*** README.md
#+begin_src markdown :tangle hosts/theologica/README.md
# Theologica

My daily driver machine, a Lenovo T14s gen 3 laptop.

## Specifications
- Model: Lenovo T14s Gen 3
- Purpose: Daily development and writing work
- Desktop: Hyprland
#+end_src

** King
*** README.md
#+begin_src markdown :tangle hosts/king/README.md
# King

My testing machine, a Lenovo T430 laptop.

## Specifications
- Model: Lenovo T430
- Purpose: Testing configurations before deploying to main machine
- Desktop: Hyprland (testing)
#+end_src
** Empirica
*** README.md
#+begin_src markdown :tangle hosts/empirica/README.md
# Empirica

Mini PC running all self-hosted services

## Specifications
- Model: Lenovo M910Q
- Purpose: Hosting all my home server stack
- Headless NixOS Server
#+end_src
** Alexandria
*** README.md
#+begin_src markdown :tangle hosts/alexandria/README.md
# Alexandria

Hetzner server database host

## Specifications
#+end_src
** Empire
** Citadel
* Modules
** Home-manager
I use [[https://github.com/nix-community/home-manager][home-manager]] to manage all dotfiles that require customization.
*** default.nix
#+begin_src nix :tangle modules/home-manager/default.nix
{ config, pkgs, inputs, ... }:

{
  imports = [
    ./tmux.nix
    ./git.nix
    ./nvim.nix
    ./zsh.nix
    ./doom.nix
    ./hyprland.nix
  ];

  home.username = "joshua";
  home.homeDirectory = "/home/joshua";
  home.stateVersion = "24.11";

  # Let home-manager manage itself
  programs.home-manager.enable = true;
}
#+end_src
*** doom.nix
#+begin_src nix :tangle modules/home-manager/doom.nix
{ config, pkgs, ... }:

{
  # Install Emacs
  home.packages = with pkgs; [
    emacs
    # Doom Emacs dependencies
    git
    ripgrep
    fd
    imagemagick
    texliveFull  # For LaTeX support
    sqlite       # For org-roam
  ];

  # Symlink your entire Doom Emacs configuration
  home.file.".config/doom".source = config.lib.file.mkOutOfStoreSymlink
    "${config.home.homeDirectory}/nixos-config/dotfiles/doom";

  # Also symlink the +STORE directory if Doom uses it
  home.file.".config/+STORE".source = config.lib.file.mkOutOfStoreSymlink
    "${config.home.homeDirectory}/nixos-config/dotfiles/+STORE";
}
#+end_src

*** tmux.nix
#+begin_src nix :tangle modules/home-manager/tmux.nix
{ config, pkgs, ... }:

{
  # Install tmux
  home.packages = with pkgs; [ tmux ];

  # Create symlink to your dotfile using mkOutOfStoreSymlink
  home.file.".tmux.conf".source = config.lib.file.mkOutOfStoreSymlink
    "${config.home.homeDirectory}/nixos-config/dotfiles/tmux.conf";

  # Also symlink your tmux plugins directory if needed
  home.file.".config/tmux".source = config.lib.file.mkOutOfStoreSymlink
    "${config.home.homeDirectory}/nixos-config/dotfiles/tmux";
}
#+end_src

*** hyprland.nix (home-manager module)
#+begin_src nix :tangle modules/home-manager/hyprland.nix
{ config, pkgs, ... }:

{
  # Just symlink your configs for live editing
  home.file.".config/hypr".source = config.lib.file.mkOutOfStoreSymlink
    "${config.home.homeDirectory}/nixos-config/dotfiles/hypr";

  home.file.".config/waybar".source = config.lib.file.mkOutOfStoreSymlink
    "${config.home.homeDirectory}/nixos-config/dotfiles/waybar";

  home.file.".config/swaync".source = config.lib.file.mkOutOfStoreSymlink
    "${config.home.homeDirectory}/nixos-config/dotfiles/swaync";

  home.file.".config/wofi".source = config.lib.file.mkOutOfStoreSymlink
      "${config.home.homeDirectory}/nixos-config/dotfiles/wofi";
}
#+end_src
*** nvim.nix
*** git.nix
#+begin_src nix :tangle modules/cli-tui/git.nix
{ config, pkgs, ... }:

{
  programs.git = {
    enable = true;
    config = {
      init.defaultBranch = "main";
      user = {
        name = "Joshua Blais";
        email = "josh@joshblais.com";
      };
      core = {
        editor = "nvim";
        autocrlf = "input";
      };
      pull.rebase = true;
      push.autoSetupRemote = true;
    };
  };

  # Install git in system packages too
  environment.systemPackages = with pkgs; [
    git
  ];
}
#+end_src
*** tmux.nix
*** zsh.nix
** Development
** CLI/TUI
*** default.nix
#+begin_src nix :tangle modules/cli-tui/default.nix
{ config, pkgs, ... }:

{
  imports = [
    ./git.nix
    ./nvim.nix
    ./zsh.nix
    ./tmux.nix
  ];

  # Tools that don't need configuration - just install them
  environment.systemPackages = with pkgs; [
    # File management
    eza              # Better ls
    yazi             # Terminal file manager
    bat              # Better cat
    fd               # Better find
    ripgrep-all      # Better grep
    fzf              # Fuzzy finder

    # Git tools
    lazygit          # Git TUI

    # System tools
    btop             # Better top
    trash-cli        # Safe rm
    tldr             # Simplified man pages
    fastfetch        # System info

    # Development containers
    podman           # Container runtime
    podman-compose   # Docker-compose for podman
  ];

  # Enable podman
  virtualisation.podman = {
    enable = true;
    dockerCompat = true;  # Create docker alias
    defaultNetwork.settings.dns_enabled = true;
  };
}
#+end_src
*** podman.nix
** Desktop
*** hyprland.nix (system module)
#+begin_src nix :tangle modules/desktop/hyprland.nix
{ config, pkgs, ... }:

{
  # Enable Hyprland at system level
  programs.hyprland = {
    enable = true;
    xwayland.enable = true;
  };

  # Install Hyprland ecosystem packages
  environment.systemPackages = with pkgs; [
    waybar
    wofi
    kitty
    swww
    grim
    slurp
    wl-clipboard
    hyprlock
    hypridle
    hyprpicker
    hyprutils
    hyprsunset
    wlsunset
    hyprwayland-scanner
    swaynotificationcenter
    polkit_gnome # for authentication flows
  ];
}
#+end_src

*** rofi.nix
Wofi on wayland
#+begin_src nix :tangle modules/desktop/wofi.nix

#+end_src
*** kitty.nix
#+begin_src nix :tangle modules/desktop/kitty.nix

#+end_src
** Server
** Services
*** calibre.nix
#+begin_src nix :tangle modules/services/calibre.nix

#+end_src
*** syncthing.nix
#+begin_src nix :tangle modules/services/syncthing.nix

#+end_src
*** homepage.nix
#+begin_src nix :tangle modules/services/homepage.nix

#+end_src
*** pihole.nix
#+begin_src nix :tangle modules/services/pihole.nix

#+end_src
*** jellyfin.nix
#+begin_src nix :tangle modules/services/jellyfin.nix

#+end_src
*** plex.nix
#+begin_src nix :tangle modules/services/plex.nix

#+end_src
*** nextcloud.nix
#+begin_src nix :tangle modules/services/nextcloud.nix

#+end_src
*** audiobookshelf.nix
#+begin_src nix :tangle modules/services/audiobookshelf.nix

#+end_src
*** lidarr.nix
#+begin_src nix :tangle modules/services/lidarr.nix

#+end_src
*** radarr.nix
#+begin_src nix :tangle modules/services/radarr.nix

#+end_src
*** prowlarr.nix
#+begin_src nix :tangle modules/services/prowlarr.nix

#+end_src
*** qbittorrent.nix
#+begin_src nix :tangle modules/services/qbittorrent.nix

#+end_src
*** gluetun.nix
#+begin_src nix :tangle modules/services/gluetun.nix

#+end_src

** Shared
** Security
*** fail2ban.nix
** Media
*** music.nix
#+begin_src nix :tangle modules/media/music.nix

#+end_src
*** video.nix
#+begin_src nix :tangle modules/media/video.nix

#+end_src
*** pdf.nix
#+begin_src nix :tangle modules/media/pdf.nix

#+end_src
* Overlays
* Secrets
We manage secrets with [[https://github.com/ryantm/agenix][agenix]].

The workflow for adding a secret is as follows:
1. Add secret to secrets.nix - specify which keys can decrypt it
2. Create the secret: agenix -e new-secret.age
3. Rekey existing secrets if you added new machines: agenix -r
4. Deploy: Your NixOS systems will automatically decrypt the secrets they have keys for

You can retrieve Machine SSH keys by running ~cat /etc/ssh/ssh_host_ed25519_key.pub~ in any Linux machine with ssh enabled.
** secrets.nix
#+begin_src nix :tangle secrets/secrets.nix
let
  # Your personal SSH public key (from ~/.ssh/joshuakey.pub)
  joshua = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICCWNto66rFbOvb1VDEDuZYdwHQPfKM7+EjpnHvs3eRr joshua@joshuablais.com";

  # Machine SSH host keys
  # king = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBb root@king";
  # theologica = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCc root@theologica";
  # alexandria = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDd root@alexandria";
  # empire = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEe root@empire";


  # Groups for convenience
  users = [ joshua ];
  # desktops = [ king theologica ];
  # servers = [ alexandria empire ];
  # allSystems = desktops ++ servers;
in
{
  # Database secrets (only for servers)
  "postgres-password.age".publicKeys = users;
}
#+end_src

* flake.nix
#+begin_src nix :tangle flake.nix
{
  description = "Joshua Blais' NixOS Configuration";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    nixpkgs-stable.url = "github:NixOS/nixpkgs/nixos-25.05";

    home-manager = {
      url = "github:nix-community/home-manager";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    deploy-rs = {
      url = "github:serokell/deploy-rs";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    agenix = {
      url = "github:ryantm/agenix";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = { self, nixpkgs, home-manager, deploy-rs, agenix, ... }@inputs: {
    nixosConfigurations = {
      # Laptop hosts
      theologica = nixpkgs.lib.nixosSystem {
        system = "x86_64-linux";
        specialArgs = { inherit inputs; };
        modules = [
          ./hosts/theologica/configuration.nix
          agenix.nixosModules.default
          ./modules/shared
          ./modules/desktop
          ./modules/cli-tui
          ./modules/development
          ./modules/media

          # Add home-manager
          home-manager.nixosModules.home-manager
          {
            home-manager.useGlobalPkgs = true;
            home-manager.useUserPackages = true;
            home-manager.users.joshua = import ./modules/home-manager;
            home-manager.extraSpecialArgs = { inherit inputs; };
          }
        ];
      };

      king = nixpkgs.lib.nixosSystem {
        system = "x86_64-linux";
        specialArgs = { inherit inputs; };
        modules = [
          ./hosts/king/configuration.nix
          agenix.nixosModules.default
          ./modules/shared
          ./modules/desktop
          ./modules/cli-tui
          ./modules/development

          # Add home-manager
          home-manager.nixosModules.home-manager
          {
            home-manager.useGlobalPkgs = true;
            home-manager.useUserPackages = true;
            home-manager.users.joshua = import ./modules/home-manager;
            home-manager.extraSpecialArgs = { inherit inputs; };
          }
        ];
      };

      # Server hosts (no home-manager needed)
      alexandria = nixpkgs.lib.nixosSystem {
        system = "x86_64-linux";
        specialArgs = { inherit inputs; };
        modules = [
          ./hosts/alexandria/configuration.nix
          agenix.nixosModules.default
          ./modules/shared
          ./modules/server
          ./modules/services
          ./modules/security
        ];
      };

      empire = nixpkgs.lib.nixosSystem {
        system = "x86_64-linux";
        specialArgs = { inherit inputs; };
        modules = [
          ./hosts/empire/configuration.nix
          agenix.nixosModules.default
          ./modules/shared
          ./modules/server
          ./modules/security
        ];
      };
    };

    # Deploy-rs configuration for remote deployment
    deploy.nodes = {
      alexandria = {
        hostname = "alexandria.your-domain.com";
        profiles.system = {
          user = "root";
          path = deploy-rs.lib.x86_64-linux.activate.nixos self.nixosConfigurations.alexandria;
        };
      };
    };
  };
}
#+end_src
